---
title: "Acadia National Park Region CBC Results"
author: "Nick Fisichelli and Kyle Lima"
date: "4/3/2022"
output:
  html_document:
    theme: readable
  
---

```{r setup, include=FALSE}

library(ggplot2)
library(dplyr)
library(utils)
library(tidyr)
library(sp)
library(ggmap)
library(rgdal)
library(cowplot)

select <- dplyr::select


cbc <- read.csv("cbc_alldata_20220403.csv")
buff1 <- readOGR("mdi_circle.kml")
buff2 <- readOGR("sch_circle.kml")
sp.tab <- read.csv("regional/speciesstats_table.csv")



#Draw images
cbirds <- ggdraw() +
  draw_image("regional/aa_CumulativeBirds.png")
phours <- ggdraw() +
  draw_image("regional/aa_PartyHours.png")
yso <- ggdraw() +
  draw_image("regional/aa_YearsSpeciesObserved.png")


T2.0 <- cbc %>%
  group_by(CommonName, Year) %>% 
  summarise(Count=sum(Count), PartyHours=sum(PartyHours)) %>% 
  mutate(CountPartyHour = Count/PartyHours)

T2 <- T2.0 %>% 
  group_by(Year) %>%
  summarise(NoSpecies=length(which(Count>0)),
            Birds=sum(Count),
            BirdsPartyHour=sum(CountPartyHour),
            PartyHours=mean(PartyHours))
F1.0 <- T2.0 %>%
  filter(Count > 0)

F1 <- F1.0 %>% 
  group_by(CommonName) %>% 
  summarise(Freq=length(Year),
            TotalBirds=sum(Count),
            TotBirdsPH=sum(CountPartyHour),
            MinYear=min(Year),
            MaxYear=max(Year))
```


## Summary Statistics

53% decline in total count of birds recorded on the CBCs since 1971. 43% decline in count of birds per party hour since 1971.


<br>
<br>


## Study Area
```{r, fig.height = 8, fig.width = 8, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

##Map
#Create dataframe with circle centers
circpoint <- data.frame(circle  = c("Mount Desert Island", "Schoodic"),
                        latitude = c("44.34", "44.43"),
                        longitude = c("-68.31", "-68.11"))

#Fix non-numeric
circpoint$latitude <- as.numeric(circpoint$latitude)
circpoint$longitude <- as.numeric(circpoint$longitude)

#Fortify for ggplot
buff1f <- fortify(buff1)
buff2f <- fortify(buff2)

#Get base map
base.map <- get_stamenmap(
  bbox = c(left = -68.61, bottom = 44.15, right = -67.83, top = 44.6),
  maptype = 'toner-lite',
  zoom = 11)

#Plot
ggmap(base.map) +
  geom_point(data = circpoint, aes(longitude, latitude, fill = circle), 
             shape = 21,
             size = 2.5,
             color = 'black') +
  geom_path(data = buff1f, aes(x=long, y=lat), color = "navyblue") +
  geom_path(data = buff2f, aes(x=long, y=lat), color = "forestgreen") +
  theme_classic(base_size = 14) +
  ggtitle("Christmas Bird Count (CBC) Circles") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        legend.position = c(0.79, 0.13),
        legend.background = element_rect(fill = "white", color = "black"),
        panel.border = element_rect(color = 'black', size = 1.5, fill = NA)) +
  scale_fill_manual("CBC circle", values = c("navyblue", "forestgreen"))

```
<br>
<br>



## Linear Relationships Through Time

<br>

Adjusted R-squared:  0.1543, F-statistic: 10.12 on 1 and 49 DF,  p-value: < 0.005
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

T2 %>% 
  ggplot(aes(Year, NoSpecies)) +
  geom_point(shape = 21, size = 1.9, color = "black") +
  geom_smooth(method = "lm", color = "navyblue") +
  theme_bw() +
  labs(title="Number of Species by Year", y="Number of species", x="Year") +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10), expand = c(0,0), limits = c(50,90)) +
  theme(plot.title = element_text(hjust = 0.5, size = 18), 
        legend.title = element_blank(),
        axis.text = element_text(color = "black", size = 14),
        axis.title = element_text(size = 15),
        strip.text.x = element_text(margin = margin(.2,0,.2,0, "cm"), color = "black", size = "12"), 
        strip.background = element_rect(colour="black", fill="gray"),
        panel.background = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.grid.major = element_blank(),
        panel.border = element_rect(color = 'black', fill = NA))

```
<br>

Adjusted R-squared:  0.4095, F-statistic: 35.68 on 1 and 49 DF,  p-value: < 0.005
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

T2 %>% 
  ggplot(aes(Year, Birds)) +
  geom_point(shape = 21, size = 1.9, color = "black") +
  geom_smooth(method = "lm", color = "navyblue", na.rm = TRUE) +
  theme_bw() +
  labs(title="Total Count of Birds by Year", y="Tatal count", x="Year") +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10), expand = c(0,0), limits = c(5000,35000)) +
  theme(plot.title = element_text(hjust = 0.5, size = 18), 
        legend.title = element_blank(),
        axis.text = element_text(color = "black", size = 14),
        axis.title = element_text(size = 15),
        strip.text.x = element_text(margin = margin(.2,0,.2,0, "cm"), color = "black", size = "12"), 
        strip.background = element_rect(colour="black", fill="gray"),
        panel.background = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.grid.major = element_blank(),
        panel.border = element_rect(color = 'black', fill = NA))

```
<br>

Adjusted R-squared:  0.02729, F-statistic: 2.403 on 1 and 49 DF,  p-value: 0.1276
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

T2 %>% 
  ggplot(aes(Year, BirdsPartyHour)) +
  geom_point(shape = 21, size = 1.9, color = "black") +
  geom_smooth(method = "lm", color = "navyblue", na.rm = TRUE) +
  theme_bw() +
  labs(title="Number of Birds/Party Hour by Year", y="Number of birds/party hour", x="Year") +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10), expand = c(0,0), limits = c(0,550)) +
  theme(plot.title = element_text(hjust = 0.5, size = 18), 
        legend.title = element_blank(),
        axis.text = element_text(color = "black", size = 14),
        axis.title = element_text(size = 15),
        strip.text.x = element_text(margin = margin(.2,0,.2,0, "cm"), color = "black", size = "12"), 
        strip.background = element_rect(colour="black", fill="gray"),
        panel.background = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.grid.major = element_blank(),
        panel.border = element_rect(color = 'black', fill = NA))

```
<br>


## Summary Figures
<br>
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

plot(phours)

```
<br>
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

plot(yso)

```
<br>
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

plot(cbirds)

```
<br>
<br>



## Increasing Species

Top 5 in descending order of severity:

1. Mallard
2. Wild Turkey
3. Bald Eagle
4. Northern Cardinal
5. Harlequin Duck


<br>

## Species showing no change

- Brown Creeper
- Dark-eyed Junco
- American Robin
- Red-breasted Nuthatch
- Song Sparrow

<br>

## Decreasing Species

Top 5 in descending order of severity:

1. Evening Grosbeak
2. American Tree Sparrow
3. Brown-headed Cowbird
4. White-winged Scoter
5. Blue Jay



<br>
<br>



## Example plot
<br>
```{r, fig.height = 7, fig.width = 9, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

ATSP <- cbc %>% 
  filter(CommonName=="American Tree Sparrow") %>% 
  mutate(t.count = Count/60)

ggplot(ATSP, aes(x=Year)) +
    geom_line(aes(y=t.count, color="Count"), size = 1.3) +
  geom_line(aes(y=CountPartyHour, color="Count/party hour"), size = 1.3) +
  scale_y_continuous(name="Count/party hour", sec.axis = sec_axis(~.*60, name="Count")) +
  theme_bw() +
  labs(title="American Tree Sparrow Population Changes Through Time", x="Year") +
  theme(plot.title = element_text(size = "18"),
        axis.text = element_text(color = "black", size = "12"),
        axis.title = element_text(size = "16"),
        axis.line.y.right = element_line(color = "#2166AC", size = 1.2), 
        axis.ticks.y.right = element_line(color = "#2166AC"),
        axis.text.y.right = element_text(color = "#2166AC"), 
        axis.title.y.right = element_text(color = "#2166AC"),
        axis.line.y.left = element_line(color = "#D6604D", size = 1.2), 
        axis.ticks.y.left = element_line(color = "#D6604D"),
        axis.text.y.left = element_text(color = "#D6604D"), 
        axis.title.y.left = element_text(color = "#D6604D"),
        strip.text.x = element_text(margin = margin(.2,0,.2,0, "cm"), color = "black", size = "13"), 
        strip.background = element_rect(colour="black", fill="gray"),
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), 
        panel.border = element_rect(color = 'black', fill = NA, size = 1),
        legend.title = element_text(size=18),
        legend.text = element_text(size=16)) +
  scale_color_manual(name="Statistic",
                     breaks=c("Count/party hour", "Count"),
                     values=c("Count/party hour"="#D6604D", "Count"="#2166AC"))

```
<br>
<br>



## Species Trend Table

The species trend is based soley on the count/party hour estimate and p-value. There are a lot more determinable trends in the count data, but I think we want to use the count/party hour metric to account for effort.

There are `r length(which(sp.tab$change=="increase"))` increasing species, `r length(which(sp.tab$change=="decrease"))` decreasing species, and `r length(which(sp.tab$change=="no change"))` that have shown no change over the last 51 years. The other `r length(which(sp.tab$change=="not enough data"))` species did not have enough data to determine a trend, beacuse they are rarely detected species (vagrants, unusual overwinterers, or irruptive species). 

<br>
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

sp.tab['species'][sp.tab['species'] == "Gray Jay"] <- 'Canada Jay'

knitr::kable(sp.tab, col.names = c('Species', 'Count estimate', 'Count p-value', 'Count/party hour estimate', 'Count/party hour p-value', 'Species trend'))

```
<br>
<br>
